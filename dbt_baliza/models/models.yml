version: 2

sources:
  - name: pncp
    schema: psa
    description: "Raw data extracted from the PNCP API"
    tables:
      - name: pncp_raw_responses
        description: "Stores raw JSON responses from the PNCP API for each page requested."
        columns:
          - name: id
            description: "Primary key for the raw response"
            tests:
              - unique
              - not_null
          - name: extracted_at
            description: "Timestamp of when the data was extracted"
          - name: endpoint_name
            description: "Name of the API endpoint"
          - name: endpoint_url
            description: "Full URL of the API endpoint"
          - name: data_date
            description: "The reference date for the data extracted"
          - name: run_id
            description: "Identifier for the extraction run"
          - name: total_records
            description: "Total records reported by the API for the request"
          - name: total_pages
            description: "Total pages reported by the API for the request"
          - name: current_page
            description: "The page number of this response"
          - name: response_content
            description: "The raw JSON content of the API response"

models:
  # Bronze Layer
  - name: bronze_atas
    description: "Bronze table that filters for valid 'ata' (minutes) responses and casts the raw content to JSON."
    columns:
      - name: id
        description: "Inherited from raw responses, primary key."
        tests:
          - unique
          - not_null
      - name: response_json
        description: "The raw response content cast to a JSON type."

  - name: bronze_contratacoes
    description: "Bronze table that filters for valid 'contratacoes' (procurement) responses and casts the raw content to JSON."
    columns:
      - name: id
        description: "Inherited from raw responses, primary key."
        tests:
          - unique
          - not_null
      - name: response_json
        description: "The raw response content cast to a JSON type."

  - name: bronze_contratos
    description: "Bronze table that filters for valid 'contrato' (contract) responses and casts the raw content to JSON."
    columns:
      - name: id
        description: "Inherited from raw responses, primary key."
        tests:
          - unique
          - not_null
      - name: response_json
        description: "The raw response content cast to a JSON type."

  # Silver Layer
  - name: silver_atas
    description: "Silver table that unnests and structures the data from price registration minutes (atas)."
    columns:
      - name: numero_controle_pncp
        description: "The unique control number for the price registration minute on PNCP."
        tests:
          - unique
          - not_null

  - name: silver_contratacoes
    description: "Silver table that unnests and structures procurement data, providing one row per procurement."
    columns:
      - name: numero_controle_pncp
        description: "The unique control number for the procurement on PNCP."
        tests:
          - unique
          - not_null

  - name: silver_contratos
    description: "Silver table that unnests and structures contract data, providing one row per contract and handling deduplication."
    columns:
      - name: numero_controle_pncp
        description: "The unique control number for the contract on PNCP."
        tests:
          - unique
          - not_null

  - name: silver_dim_organizacoes
    description: "A dimension table for organizations, providing a clean, deduplicated list of public entities."
    columns:
      - name: org_key
        description: "The surrogate key for the organization."
        tests:
          - unique
          - not_null
      - name: cnpj
        description: "The natural key for the organization (CNPJ)."
        tests:
          - unique
          - not_null
      - name: razao_social
        description: "The official name of the organization."
      - name: poder_id
        description: "The ID of the branch of government (e.g., E, L, J, M)."
      - name: esfera_id
        description: "The ID of the governmental sphere (e.g., F, E, M)."
      - name: poder_nome
        description: "The name of the branch of government (Executivo, Legislativo, etc.)."
      - name: esfera_nome
        description: "The name of the governmental sphere (Federal, Estadual, etc.)."
      - name: created_at
        description: "The timestamp when the record was first created."
      - name: updated_at
        description: "The timestamp when the record was last updated."

  - name: silver_dim_unidades_orgao
    description: "A dimension table for organizational units, providing a clean, deduplicated list of specific units within organizations."
    columns:
      - name: unit_key
        description: "The surrogate key for the organizational unit."
        tests:
          - unique
          - not_null

  - name: silver_fact_contratacoes
    description: "A fact table for procurements, containing key metrics and foreign keys to dimension tables."
    columns:
      - name: procurement_key
        description: "The surrogate key for the procurement."
        tests:
          - unique
          - not_null
      - name: org_key
        description: "Foreign key to the organizations dimension."
        tests:
          - relationships:
              to: ref('silver_dim_organizacoes')
              field: org_key
      - name: unit_key
        description: "Foreign key to the organizational units dimension."
        tests:
          - relationships:
              to: ref('silver_dim_unidades_orgao')
              field: unit_key

  - name: silver_fact_contratos
    description: "A fact table for contracts, containing key metrics and foreign keys to dimension tables."
    columns:
      - name: contract_key
        description: "The surrogate key for the contract."
        tests:
          - unique
          - not_null
      - name: org_key
        description: "Foreign key to the organizations dimension."
        tests:
          - relationships:
              to: ref('silver_dim_organizacoes')
              field: org_key
      - name: unit_key
        description: "Foreign key to the organizational units dimension."
        tests:
          - relationships:
              to: ref('silver_dim_unidades_orgao')
              field: unit_key
      - name: numero_controle_pncp_compra
        description: "The control number of the associated procurement, used to join with the procurement fact table."

  # Gold Layer
  - name: mart_procurement_analytics
    description: "An analytics mart that combines procurement and contract data to provide a comprehensive view for business intelligence and analysis. It includes calculated metrics and quality indicators."
    columns:
      - name: numero_controle_pncp
        description: "The unique control number for the procurement, serving as the primary key for the mart."
        tests:
          - unique
          - not_null
