version: 2

models:
  - name: silver
    description: "The silver layer contains cleaned, validated, and enriched data from the bronze layer. It serves as the single source of truth for downstream analytics and reporting."
  - name: silver_contratos
    description: "Clean, deduplicated contract data with business logic applied"
    columns:
      - name: numero_controle_pncp
        description: "PNCP control number - unique identifier for each contract"
        tests:
          - unique
          - not_null
      - name: data_atualizacao
        description: "Last update timestamp for the contract"
        tests:
          - not_null
      - name: valor_inicial
        description: "Initial contract value in BRL"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: number
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1000000000
  - name: silver_atas
    description: "Clean, deduplicated contract data with business logic applied"
    columns:
      - name: numero_controle_pncp
        description: "PNCP control number - unique identifier for each contract"
        tests:
          - unique
          - not_null
  - name: silver_contratacoes
    description: "Clean, deduplicated contract data with business logic applied"
    columns:
      - name: numero_controle_pncp
        description: "PNCP control number - unique identifier for each contract"
        tests:
          - unique
          - not_null
  - name: silver_documentos
    description: "Clean, deduplicated contract data with business logic applied"
    columns:
      - name: numero_controle_pncp
        description: "PNCP control number - unique identifier for each contract"
        tests:
          - unique
          - not_null
  - name: silver_itens_contratacao
    description: "Clean, deduplicated contract data with business logic applied"
    columns:
      - name: numero_controle_pncp
        description: "PNCP control number - unique identifier for each contract"
        tests:
          - unique
          - not_null
      - name: tipo_pessoa
        description: "Type of legal entity (fisica/juridica)"
        tests:
          - accepted_values:
              values: ["PESSOA_FISICA", "PESSOA_JURIDICA"]
      - name: ni_fornecedor
        description: "Supplier identification number (CPF/CNPJ)"
        tests:
          - not_null
      - name: nome_razao_social_fornecedor
        description: "Supplier name or company name"
        tests:
          - not_null
      - name: data_assinatura
        description: "Contract signature date"
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: date
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: '2000-01-01'
              max_value: "{{ modules.datetime.date.today().strftime('%Y-%m-%d') }}"
      - name: data_vigencia_inicio
        description: "Contract validity start date"
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: date
      - name: data_vigencia_fim
        description: "Contract validity end date"
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: date
          - dbt_expectations.expect_column_values_to_be_greater_than_or_equal_to:
              column_name: data_vigencia_inicio

  - name: silver_dim_organizacoes
    description: "Organization dimension table"
    columns:
      - name: org_key
        description: "Surrogate key for organization"
        tests:
          - unique
          - not_null
      - name: cnpj
        description: "Organization CNPJ"
        tests:
          - not_null

  - name: silver_dim_unidades_orgao
    description: "Organizational unit dimension table"
    columns:
      - name: unit_key
        description: "Surrogate key for organizational unit"
        tests:
          - unique
          - not_null

  - name: silver_fact_contratos
    description: "Contract fact table with foreign keys to dimensions. This model is for contracts, not to be confused with `silver_fact_contratacoes`."
    columns:
      - name: numero_controle_pncp
        description: "PNCP control number"
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('silver_contratos')
              field: numero_controle_pncp
      - name: org_key
        description: "Foreign key to organization dimension"
        tests:
          - not_null
          - relationships:
              to: ref('silver_dim_organizacoes')
              field: org_key
      - name: unit_key
        description: "Foreign key to organizational unit dimension"
        tests:
          - not_null
          - relationships:
              to: ref('silver_dim_unidades_orgao')
              field: unit_key
          - not_null
      - name: valor_inicial
        description: "Initial contract value in BRL"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_not_be_null:
              min_value: 0